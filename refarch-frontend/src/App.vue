<template>
  <v-app>
    <the-snackbar />
    <v-app-bar color="primary">
      <v-row align="center">
        <v-col cols="3" class="d-flex align-center justify-start">
          <v-app-bar-nav-icon @click.stop="toggleDrawer()" />
          <router-link to="/">
            <v-toolbar-title class="font-weight-bold">
              <span class="text-white">{{ "Task" }}</span>
              <span class="text-secondary">{{ "Together" }}</span>
              <span class="text-white">{{ "_HOME" }}</span>
            </v-toolbar-title>
          </router-link>
        </v-col>
        <v-col cols="6" class="d-flex align-center justify-center">
          <p class="text-h4">{{ "Willkommen" }}</p>
        </v-col>
        <v-col cols="3" class="d-flex align-center justify-end">
          <app-switcher
              v-if="appswitcherBaseUrl"
              :base-url="appswitcherBaseUrl"
              :tags="['global']"
              :icon="mdiApps"
          />
          <v-btn variant="text" icon>
            <ad2-image-avatar
                v-if="userStore.getUser !== null"
                :username="userStore.getUser.username"
            />
          </v-btn>
        </v-col>
      </v-row>
    </v-app-bar>

    <v-navigation-drawer v-model="drawer" v-if="!isAdmin">
      <v-list>
        <v-list-item :to="{ name: ROUTES_GETSTARTED }">
          <v-list-item-title>{{ "First Steps" }}</v-list-item-title>
        </v-list-item>
        <v-list-item :to="{ name: ROUTES_NOTIZENANSICHT }">
          <v-list-item-title> Übersicht </v-list-item-title>
        </v-list-item>
        <v-list-item :to="{ name: ROUTES_PERSOENLICHE_TODOS }">
          <v-list-item-title> Persönliche TODOs </v-list-item-title>
        </v-list-item>
        <v-list-item :to="{ name: ROUTES_MIR_ZUGEWIESENE_TODOS }">
          <v-list-item-title> Zugewiesene TODOs </v-list-item-title>
        </v-list-item>
      </v-list>
    </v-navigation-drawer>

    <v-main>
      <v-container fluid>
        <router-view v-slot="{ Component }">
          <v-fade-transition mode="out-in">
            <component :is="Component" />
          </v-fade-transition>
        </router-view>
      </v-container>
    </v-main>
  </v-app>
</template>

<script setup lang="ts">
import { mdiApps } from "@mdi/js";
import { AppSwitcher } from "@muenchen/appswitcher-vue";
import { useToggle } from "@vueuse/core";
import { onMounted, ref } from "vue";

import { getUser } from "@/api/user-client";
import Ad2ImageAvatar from "@/components/common/Ad2ImageAvatar.vue";
import TheSnackbar from "@/components/TheSnackbar.vue";
import {
  APPSWITCHER_URL,
  ROUTES_GETSTARTED,
  ROUTES_MIR_ZUGEWIESENE_TODOS,
  ROUTES_NOTIZENANSICHT,
  ROUTES_PERSOENLICHE_TODOS,
} from "@/constants";
import { useUserStore } from "@/stores/user";
import User, { UserLocalDevelopment } from "@/types/User";

const appswitcherBaseUrl = APPSWITCHER_URL;

const userStore = useUserStore();
const [drawer, toggleDrawer] = useToggle();
const isAdmin = ref(false);

onMounted(() => {
  loadUser();
});

function loadUser(): void {
  getUser()
      .then((user: User) => {
        console.debug("API-Antwort:", user);
        userStore.setUser(user);

        const userRoles = user.authorities || [];
        console.debug("Benutzerrollen:", userRoles);
        isAdmin.value = userRoles.includes("ROLE_admin");

        console.debug("Is Admin:", isAdmin.value);
      })
      .catch((error) => {
        console.debug("Fehler beim Laden des Benutzers:", error);
        if (import.meta.env.DEV) {
          userStore.setUser(UserLocalDevelopment());
        } else {
          userStore.setUser(null);
        }
      });
}
</script>
